apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: fhirhub-alerts
  namespace: monitoring
  labels:
    release: prometheus
    app: kube-prometheus-stack
spec:
  groups:
    - name: fhirhub.service.health
      rules:
        - alert: ApiDown
          expr: up{job="fhirhub-api"} == 0
          for: 5m
          labels:
            severity: critical
            service: fhirhub-api
          annotations:
            summary: "FhirHub API is down"
            description: "FhirHub API target has been down for more than 5 minutes. Job: {{ $labels.job }}, Instance: {{ $labels.instance }}."
            runbook_url: "https://wiki.internal/runbooks/fhirhub-api-down"

        - alert: HapiFhirDown
          expr: up{job="hapi-fhir"} == 0
          for: 5m
          labels:
            severity: critical
            service: hapi-fhir
          annotations:
            summary: "HAPI FHIR Server is down"
            description: "HAPI FHIR Server target has been down for more than 5 minutes. Job: {{ $labels.job }}, Instance: {{ $labels.instance }}."
            runbook_url: "https://wiki.internal/runbooks/hapi-fhir-down"

        - alert: KeycloakDown
          expr: up{job="keycloak"} == 0
          for: 5m
          labels:
            severity: critical
            service: keycloak
          annotations:
            summary: "Keycloak is down"
            description: "Keycloak target has been down for more than 5 minutes. Job: {{ $labels.job }}, Instance: {{ $labels.instance }}."
            runbook_url: "https://wiki.internal/runbooks/keycloak-down"

        - alert: PostgreSQLDown
          expr: up{job="postgresql"} == 0
          for: 5m
          labels:
            severity: critical
            service: postgresql
          annotations:
            summary: "PostgreSQL is down"
            description: "PostgreSQL target has been down for more than 5 minutes. Job: {{ $labels.job }}, Instance: {{ $labels.instance }}."
            runbook_url: "https://wiki.internal/runbooks/postgresql-down"

    - name: fhirhub.api.performance
      rules:
        - alert: HighErrorRate
          expr: |
            (
              sum(rate(http_requests_received_total{job="fhirhub-api", code=~"5.."}[5m]))
              /
              sum(rate(http_requests_received_total{job="fhirhub-api"}[5m]))
            ) * 100 > 5
          for: 5m
          labels:
            severity: warning
            service: fhirhub-api
          annotations:
            summary: "FhirHub API high error rate"
            description: "FhirHub API is returning more than 5% HTTP 5xx errors. Current error rate: {{ $value | printf \"%.2f\" }}%."
            runbook_url: "https://wiki.internal/runbooks/fhirhub-high-error-rate"

        - alert: HighLatency
          expr: |
            histogram_quantile(0.99,
              sum(rate(http_request_duration_seconds_bucket{job="fhirhub-api"}[5m])) by (le)
            ) > 2
          for: 10m
          labels:
            severity: warning
            service: fhirhub-api
          annotations:
            summary: "FhirHub API high latency"
            description: "FhirHub API p99 latency is above 2 seconds for more than 10 minutes. Current p99: {{ $value | printf \"%.2f\" }}s."
            runbook_url: "https://wiki.internal/runbooks/fhirhub-high-latency"

    - name: fhirhub.resources
      rules:
        - alert: HighMemory
          expr: |
            (
              container_memory_working_set_bytes{namespace="fhirhub", container!="", container!="POD"}
              /
              kube_pod_container_resource_limits{namespace="fhirhub", resource="memory"}
            ) * 100 > 90
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "High memory usage detected"
            description: "Container {{ $labels.container }} in pod {{ $labels.pod }} is using more than 90% of its memory limit for over 10 minutes. Current usage: {{ $value | printf \"%.1f\" }}%."
            runbook_url: "https://wiki.internal/runbooks/fhirhub-high-memory"
