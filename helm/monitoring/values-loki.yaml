# Loki Stack Helm values for FhirHub
# Install: helm install loki grafana/loki-stack -n monitoring -f values-loki.yaml

loki:
  enabled: true
  deploymentMode: SingleBinary
  loki:
    auth_enabled: false
    commonConfig:
      replication_factor: 1
    storage:
      type: filesystem
    schemaConfig:
      configs:
        - from: "2024-01-01"
          store: tsdb
          object_store: filesystem
          schema: v13
          index:
            prefix: index_
            period: 24h
    limits_config:
      retention_period: 168h
      enforce_metric_name: false
      reject_old_samples: true
      reject_old_samples_max_age: 168h
      max_entries_limit_per_query: 5000
      max_query_series: 500
    compactor:
      working_directory: /tmp/loki/compactor
      retention_enabled: true
      delete_request_store: filesystem
    storage_config:
      filesystem:
        directory: /tmp/loki/chunks
      tsdb_shipper:
        active_index_directory: /tmp/loki/tsdb-index
        cache_location: /tmp/loki/tsdb-cache
  singleBinary:
    replicas: 1
    persistence:
      enabled: true
      size: 20Gi
  gateway:
    enabled: false
  monitoring:
    selfMonitoring:
      enabled: false
    lokiCanary:
      enabled: false
  test:
    enabled: false

promtail:
  enabled: true
  config:
    clients:
      - url: http://loki:3100/loki/api/v1/push
    snippets:
      pipelineStages:
        # --- FhirHub .NET API (Serilog JSON) ---
        - match:
            selector: '{app="fhirhub-api"}'
            stages:
              - json:
                  expressions:
                    timestamp: Timestamp
                    level: Level
                    message: RenderedMessage
                    exception: Exception
                    sourceContext: Properties.SourceContext
                    requestPath: Properties.RequestPath
                    statusCode: Properties.StatusCode
                    elapsed: Properties.Elapsed
                    traceId: Properties.TraceId
                    spanId: Properties.SpanId
              - labels:
                  level:
                  sourceContext:
                  statusCode:
              - timestamp:
                  source: timestamp
                  format: "2006-01-02T15:04:05.0000000Z07:00"
              - output:
                  source: message

        # --- FhirHub Next.js Frontend ---
        - match:
            selector: '{app="fhirhub-frontend"}'
            stages:
              - regex:
                  expression: '^(?P<level>(info|warn|error|debug))\s+-\s+(?P<message>.*)$'
              - json:
                  expressions:
                    level: level
                    message: msg
                    timestamp: time
              - labels:
                  level:
              - output:
                  source: message

        # --- HAPI FHIR Server (Java / Logback) ---
        - match:
            selector: '{app="hapi-fhir"}'
            stages:
              - regex:
                  expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}\.\d{3})\s+(?P<level>\w+)\s+\[(?P<thread>[^\]]+)\]\s+(?P<logger>[^\s]+)\s+-\s+(?P<message>.*)$'
              - labels:
                  level:
                  logger:
                  thread:
              - timestamp:
                  source: timestamp
                  format: "2006-01-02 15:04:05.000"
              - output:
                  source: message

        # --- Keycloak Logs ---
        - match:
            selector: '{app="keycloak"}'
            stages:
              - regex:
                  expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2},\d{3})\s+(?P<level>\w+)\s+\[(?P<logger>[^\]]+)\]\s+\((?P<thread>[^\)]+)\)\s+(?P<message>.*)$'
              - labels:
                  level:
                  logger:
              - timestamp:
                  source: timestamp
                  format: "2006-01-02 15:04:05,000"
              - output:
                  source: message

        # --- Default: add namespace and pod labels ---
        - match:
            selector: '{namespace="fhirhub"}'
            stages:
              - labeldrop:
                  - filename

  tolerations:
    - effect: NoSchedule
      operator: Exists

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi

# Pre-configure Loki as a Grafana datasource
grafana:
  enabled: false
  sidecar:
    datasources:
      enabled: true
  additionalDataSources:
    - name: Loki
      type: loki
      access: proxy
      url: http://loki:3100
      isDefault: false
      jsonData:
        maxLines: 1000
        derivedFields:
          - datasourceUid: prometheus
            matcherRegex: "TraceId=(\\w+)"
            name: TraceId
            url: "$${__value.raw}"
      editable: true
